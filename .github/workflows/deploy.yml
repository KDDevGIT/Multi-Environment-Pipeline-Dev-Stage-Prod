name: CD (deploy on env branches)


on:
push:
branches: [dev, stage, prod]
workflow_dispatch:
inputs:
environment:
description: "Environment to deploy"
type: choice
options: [dev, stage, prod]
required: true


permissions:
id-token: write
contents: read


env:
AWS_REGION: ${{ vars.AWS_REGION || 'us-west-2' }}


jobs:
deploy:
runs-on: ubuntu-latest
concurrency:
group: terraform-${{ github.ref_name }}
cancel-in-progress: false


# Map branch to environment for approvals and secrets
environment: ${{ github.event_name == 'workflow_dispatch' && inputs.environment || github.ref_name }}


steps:
- name: Checkout
uses: actions/checkout@v4


- name: Set up Terraform
uses: hashicorp/setup-terraform@v3
with:
terraform_version: 1.7.5


- name: Configure AWS credentials (OIDC)
uses: aws-actions/configure-aws-credentials@v4
with:
aws-region: ${{ env.AWS_REGION }}
role-to-assume: ${{ secrets.AWS_ROLE_ARN }}


- name: Terraform init
run: |
terraform -chdir=terraform init \
-backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
-backend-config="key=${{ job.environment }}/terraform.tfstate" \
-var-file=../envs/${{ job.environment }}.tfvars